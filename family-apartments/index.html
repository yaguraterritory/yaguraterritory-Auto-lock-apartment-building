<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ファミリー向けオートロックマンション地図</title>
<style>
    /* 共通フォント設定：iOS, Windows, Androidで最適なゴシック体を表示 */
    body, html { 
      margin:0; 
      padding:0; 
      height:100%; 
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
    }
    #map { width:100%; height:100%; }

    /* 戻るボタンのスタイル：サイズアップと目立つ配色へ変更 */
    .back-button {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 1001;
      
      background: #007bff; /* 青色の背景に変更して目立たせる */
      color: white;        /* 文字を白に */
      text-decoration: none;
      padding: 14px 24px;  /* サイズを拡大 */
      border-radius: 12px; /* 角を丸くしてボタン感を強調 */
      font-weight: bold;
      font-size: 18px;     /* 文字サイズをアップ */
      
      display: flex;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); /* 影を強くして浮き上がらせる */
      border: 2px solid white; /* 白い枠線を追加 */
      transition: transform 0.2s; /* タップ時の動き */
    }

    .back-button:hover {
      background: #3399ff;
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
      transform: none;   /* ← 動かさない */
    }

    /* タップ・クリック時の反応 */
    .back-button:active {
      background: #0056b3;
      transform: scale(0.95);
    }

    /* 戻るアイコン（三角形）の調整 */
    .back-icon {
      margin-right: 8px;
      font-size: 16px;      /* 三角形は大きく見えやすいため少しサイズを調整 */
      position: relative;
      top: -1px;           /* 文字との上下中央を合わせるための微調整 */
    }

    /* スマホ（幅600px以下）でも十分な大きさを維持 */
    @media (max-width: 600px) {
      .back-button {
        padding: 10px 18px;
        font-size: 15px;
      }
    }

    /* タイトルを右上に配置し、はみ出しを防止 */
    .map-title {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 1000;

      background: rgba(0, 0, 0, 0.55); /* ← グレー系で控えめに */
      color: #f1f1f1;

      padding: 8px 14px;              /* ← 少し小さく */
      border-radius: 6px;

      font-size: 14px;                /* ← 文字を小さめに */
      font-weight: 500;               /* ← 太字をやめる */
      box-shadow: none;               /* ← 影を消す */

      max-width: 50%;
      text-align: center;
    }

    /* PC・タブレット向けの調整 */
    @media (min-width: 768px) {
      .map-title {
        right: 20px;
        font-size: 20px;
        padding: 15px 25px;
        max-width: 400px;
      }
      .map-ui {
      top: 20px;
      }
    }

    .map-ui {
    position: absolute;
    top: 15px;
    z-index: 1000;
    }

</style>
</head>
<body>
  <a href="../menu.html" class="back-button map-ui">
    <span class="back-icon">◀</span> 戻る
  </a>
  <div id="map"></div>
  <div class="map-title map-ui">ファミリー向けマンション</div>

<script>
    const DEFAULT_GID = "1854135294";
    let map;
    let apartmentMarkerObjects = [];
    let userMarker = null;
    let shadowMarker = null;
    let isGrowing = true;
    const APT_SCALE_FACTOR = 70;

    const INITIAL_CENTER = { lat: 35.012, lng: 135.965 };

    // アイコンサイズを決定する関数
    function getMarkerScale() {
      const w = window.innerWidth;
      const h = window.innerHeight;

      // 【スマホ・小型デバイス判定】
      // 縦長判定 (h > w) を削除し、幅 768px 以下なら一律スマホ用を適用
      if (w <= 768) {
        return { 
          apt: 0.1,
          user: 20     
        }; 
      }

      // 【中型タブレット・スマホ横持ち】
      if (w <= 1024) {
        return { 
          apt: 0.05,
          user: 15 
        }; 
      }
      
      // 【PC・大型タブレット】
      // 密集地でも道路がしっかり見えるように限界まで小さく設定
      return { 
        apt: 0.03,     // 0.06から半減（極小）
        user: 8        // 10からさらに縮小
      };
    }

    const apartments = [
      //01-青地町
      { name: "EL ORIENTE2", position: { lat: 35.0135221, lng: 135.9716834 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1fFXXiD0sLCDSXHcwuEA-6Ni0H75Mqn3E5XeouxUecH4/edit?usp=drive_link", active: true },
      { name: "アルタ青地ビュー", position: { lat: 35.0083318, lng: 135.9750119 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1wPD_lAmSwl048ySvOfsXt2YDT4g_Y4A1qavWODyvmQE/edit?usp=drive_link", active: true },
      { name: "ガーデンハイツヤマキ", position: { lat: 35.0042782, lng: 135.9707617 }, sheetUrl: "https://docs.google.com/spreadsheets/d/11to3i5Vp4oryYHFgv_HjEyBWTELm0dIX5F-wS3-wskc/edit?usp=drive_link", active: true },
      { name: "クランボナール", position: { lat: 35.0040314, lng: 135.9714115 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1DjAYqQJinkgsuvS-Zcktn5F_vWlpcETuH-VAhMZgnUU/edit?usp=drive_link", active: true },
      { name: "シルクトレーテA棟", position: { lat: 35.0073924, lng: 135.9740855 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Z8o8TeEruSnAPGF2cz8eHAwXga83YiKR7hjiIFv6I44/edit?usp=drive_link", active: true },
      { name: "シルクトレーテB棟", position: { lat: 35.0075715, lng: 135.974253 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Y3VBZdorqjHs5qvgFj-HVSfZ1xljD29fUKFh22XVtok/edit?usp=drive_link", active: true },
      //02-岡本町(該当なし)
      //03-追分
      { name: "Baum Dorf", position: { lat: 35.0061945, lng: 135.9606194 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1k5eGzP9Q5y7FOKatjdDF0nsMKI70no57Gwjk_n1QVt8/edit?usp=drive_link", active: true },
      { name: "デン・エデン", position: { lat: 35.0069946, lng: 135.9663906 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1JYeseuW3XgNATa02zqmfFfMMTCN6pv_UrtSs6xHKHfE/edit?usp=drive_link", active: true },
      //04-追分南
      { name: "シャーメゾンシルク", position: { lat: 35.0006301, lng: 135.9602304 }, sheetUrl: "https://docs.google.com/spreadsheets/d/17JkS4L9lBr00t-3qHFM7PbV4qTlpVRh4q04f0-HpgQI/edit?usp=drive_link", active: true },
      { name: "ミニオン一期一会", position: { lat: 34.9911528, lng: 135.9644665 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1C-3EfysaaJ3Dc1XQs_YmMlqUz2EQSZZGd4CH75X2_aY/edit?usp=drive_link", active: true },
      //05-矢倉
      { name: "グランツ21", position: { lat: 35.0121479, lng: 135.9545661 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1tGIFJe2Zu41FfSr_ovIN9ztkV1ksaJcwQLB6wdENLYk/edit?usp=drive_link", active: true },
      { name: "ルミエール23", position: { lat: 35.0102764, lng: 135.9568417 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1o91Gm5xHU_Mwc_avjL8X8jZnW3p-PbAeaqE7SDXzU_U/edit?usp=drive_link", active: true },
      //06-東矢倉
      { name: "Beacon Hill", position: { lat: 35.0052714, lng: 135.9562878 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1t-oHZ-qtwQRDFP2h9ZcPV02WWAfNPlDdlEKTx09Mgdg/edit?usp=drive_link", active: true },
      { name: "T・K矢倉", position: { lat: 35.0081852, lng: 135.9567579 }, sheetUrl: "https://docs.google.com/spreadsheets/d/16ydzVLR0ITFKdmbUDqruJwri2JkHY43s4xS_mPtS-n4/edit?usp=drive_link", active: true },
      { name: "グランドール南草津（夜）", position: { lat: 34.9988134, lng: 135.9556927 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1UULv7-usq5FARW_5sHf8-JDb08wSKeHoL-bLd1byu0U/edit?usp=drive_link", active: true },
      //07-西矢倉
      { name: "エムティエス・古川", position: { lat: 35.0107368, lng: 135.9513894 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1nd9cfDZ_xrmRpE-U-MXf1mYutgc3k_0X2V7BDU9eFoM/edit?usp=drive_link", active: true },
      { name: "ラ・ルース一番館（レジデンス南草津）", position: { lat: 35.0094519, lng: 135.951209 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1E95yS7ioGm6-0Le8wwtagBG-66bGKvG87iZPs9Uf5-k/edit?usp=drive_link", active: true },
      //08-草津
      { name: "Casa raffine草津", position: { lat: 35.0151292, lng: 135.9645046 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1m4m8h38AvbpoUG5HQnwuJ48wCz_0_9AhX9AcD4Msc50/edit?usp=drive_link", active: true },
      { name: "Univaly Granvia8", position: { lat: 35.0144335, lng: 135.9542681 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1osRRkvEggcPCTk6ekgo0P0N8QyRWYgKY2lFNk-Hxe8E/edit?usp=drive_link", active: true },
      { name: "アスリス", position: { lat: 35.013938, lng: 135.9537055 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1VEAgmMdwksAspOc2OtUOBS4D4oThkmrH4CnPieieruI/edit?usp=drive_link", active: true },
      { name: "グランシェーネ", position: { lat: 35.0175781, lng: 135.947824 }, sheetUrl: "https://docs.google.com/spreadsheets/d/17otURhvs9F2-3FKXJR-pfu9UelBP_kTS094Iq7_sVq4/edit?usp=drive_link", active: true },
      { name: "コスモ草津(夜)", position: { lat: 35.0173991, lng: 135.9598398 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1B0XWvPqDTWqSDrGUnyGL8BSpnWweoTZum18fHcBAWeo/edit?usp=drive_link", active: true },
      { name: "ココスモ草津Ⅱ (夜)", position: { lat: 35.0176379, lng: 135.9587089 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1lXneTb9wbrFJdMxuLgrnWV1k5OKfvvt-paiqSK5bplk/edit?usp=drive_link", active: true },
      { name: "リベルテ草津", position: { lat: 35.018516, lng: 135.9591753 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1_m6rkEhG_xr2BvVzgObUTuXZdcb08LL0XQEdkekwCto/edit?usp=drive_link", active: true },
      { name: "草津パークホームズ", position: { lat: 35.0122945, lng: 135.9559939 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1GzoYd8o3zq5ykqf_eYWAL3qkAZQAccDt9J4j7DFgZPc/edit?usp=drive_link", active: true },
      //09-南草津
      { name: "Brillia南草津駅前（夜）", position: { lat: 35.0033092, lng: 135.9462489 }, sheetUrl: "https://docs.google.com/spreadsheets/d/10NTsP0d86RR0lZrVxCHys0m74J83CtlVaWap3sjKl-w/edit?usp=drive_link", active: true },
      { name: "Chum（チャム）", position: { lat: 35.0023981, lng: 135.9424747 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1G5taBW_tUrnc8sH6TcDDsLCXBOVpQlsARtpfdZBpCHY/edit?usp=drive_link", active: true },
      { name: "Grand Cuore グランクオーレ", position: { lat: 35.0035923, lng: 135.9391534 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1vpY5rwTuiT6-FAc_A1V5kbyYR6mdvb5PiJ6ZrhZZG3I/edit?usp=drive_link", active: true },
      { name: "Twin Brick", position: { lat: 35.004649, lng: 135.9415652 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1vtvG7He0ijBhagbgCRrXASo24EiS9hOT7HmqRhjJbJ8/edit?usp=drive_link", active: true },
      { name: "アリウム南草津", position: { lat: 35.0022664, lng: 135.9420771 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Cv5gsaZ7m4mcInDuLwoGs0npbEQVf0KE9dWqQNgMV8U/edit?usp=drive_link", active: true },
      { name: "ヴィヴァーチェ", position: { lat: 35.0025239, lng: 135.9433743 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1RU0GwLLI06LRutPIXO_t35piqSim1Ki_XKvlKyqRoVc/edit?usp=drive_link", active: true },
      { name: "オークレイ・コート", position: { lat: 35.0032742, lng: 135.9402523 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1nGeqptt-sZgwZ_RLqhY3eTVnluonoVX8RyvgHKqseG4/edit?usp=drive_link", active: true },
      { name: "セシリー南草津", position: { lat: 35.0046782, lng: 135.941383 }, sheetUrl: "https://docs.google.com/spreadsheets/d/18JRifkN16EvoVTmeW7uNO9YJJ6rNZL8XpXulFZynkwQ/edit?usp=drive_link", active: true },
      { name: "トップクレスト秀", position: { lat: 35.0028437, lng: 135.94262 }, sheetUrl: "https://docs.google.com/spreadsheets/d/184c1SerXtQJ29Lig41FvNgfhmqUE-qLfpWk5csGpQcg/edit?usp=drive_link", active: true },
      { name: "パデシオン南草津駅前", position: { lat: 35.0039875, lng: 135.9451044 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1jKhsqmNWKt5MFcnehKNc7R4R6CrUxnu-JzQBtvY-bXo/edit?usp=drive_link", active: true },
      { name: "ブリックヤード", position: { lat: 35.0036021, lng: 135.9403796 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1-1Ly-uvVDaN8uHz07Shzav0io60Hfj_9kSH26LrihCg/edit?usp=drive_link", active: true },
      { name: "ベルヴィ南草津壱番館", position: { lat: 35.00478, lng: 135.9441479 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1E5az8wEnLd7VLV-66hHfgNWNIXp8KN3BnGcBgwQxYOc/edit?usp=drive_link", active: true },
      { name: "ベルヴィ南草津弐番館", position: { lat: 35.0050949, lng: 135.9444893 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1dUQSVGtrZMHbenesNzDSojon7bGy7q29la2xw662_Dg/edit?usp=drive_link", active: true },
      { name: "レジェ南草津（夜）", position: { lat: 35.0029847, lng: 135.9441943 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1KYxEDQm1FqUecTFzZvwZbGfBV_-dd_ZloVDEN5yrYnU/edit?usp=drive_link", active: true },
      { name: "レジェ南草津Ⅱ", position: { lat: 35.0032446, lng: 135.9440146 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1rK9Rr4dykUo6pmmyEDKE31luisiGHQiqpW4XQ1lRZtc/edit?usp=drive_link", active: true },
      { name: "南笠ハイツ", position: { lat: 34.9949134, lng: 135.9388712 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1cVj98XZFXwEZ7GOei7EwNUqDoRXUoIby0BxXyNzjoWY/edit?usp=drive_link", active: true },
      { name: "利兵衛 壱番館", position: { lat: 35.0057917, lng: 135.9426408 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1hJLz9dnuqjVyd-BtlyJJaLBAWBGD8GWF72CBPFlCEgQ/edit?usp=drive_link", active: true },
      //10-東草津
      { name: "EL ORIENTE", position: { lat: 35.0137968, lng: 135.9714161 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1HepljRa8BuzefsprwQZSJH6o0I7CyadMqoAws5GOLFo/edit?usp=drive_link", active: true },
      { name: "アコール東草津", position: { lat: 35.0157344, lng: 135.9690205 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1wLwjORPfoqZeSEJSxQY9UyXZ5vQ6AClQV01IFK3QavU/edit?usp=drive_link", active: true },
      { name: "パルト・プロムナードⅠ", position: { lat: 35.0099677, lng: 135.9655099 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1PcPVOsVz74IC07Mw0W8JEB77nF4uXXhS_PlAYLoUQhE/edit?usp=drive_link", active: true },
      { name: "パルト・プロムナードⅡ", position: { lat: 35.0100723, lng: 135.9654017 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1g16_levlWN8ylGeqR3lmHddeC8vL_DDbbG6_JoJNfks/edit?usp=drive_link", active: true },
      //11-野路
      { name: "SMART COURT", position: { lat: 34.996031494243915, lng: 135.9461915698387 }, sheetUrl: "https://docs.google.com/spreadsheets/d/10c_Zq7wZTWTCzKkwPTscGnphzVJFAgH_-k5HQOpyp5M/edit?usp=drive_link", active: true },
      { name: "アトレー南草津", position: { lat: 35.00434389311668, lng: 135.9491871359003 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1tR7WFiFby7QvXjVCIhvaTFf-dEWmEcmrWX45rBgrt34/edit?usp=sharing",  active: true },
      { name: "アネシス南草津", position: { lat: 35.000523881509885, lng: 135.94938429325336 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1jdm6CbsYguxNPz6qkEj3UcQ_BqCkpn6dAhl6T5Jc7FM/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津", position: { lat: 35.00419100924685, lng: 135.9489785678388 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1BHM11Gq9eeC0FDMwEGJlv9KM-0QipDev4DZXYp-d08s/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅲ", position: { lat: 35.00427508278286, lng: 135.95009593949666 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1WGjYPS6FIkdlqwPfa9d-4sF2f-axEGlvvAJ_jceEgqs/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅳ", position: { lat: 35.00297531765123, lng: 135.9501752202413 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1bHVPe_T_4zR7ceHDri46QV52BIgTTMHD2K0kknaOaqg/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅴ", position: { lat: 35.00188036824026, lng: 135.9484117067471 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1A0wCBwqX5a-n10C-rdX5Zu2X9SZN84KQGrY1nJixj9Q/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅵ", position: { lat: 35.00536061730288, lng: 135.94923667584646 }, sheetUrl: "https://docs.google.com/spreadsheets/d/18iXjeaSOFZHz-KanbTXz02rZBA0f0Ylmuol8_zLLUu4/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅶ", position: { lat: 35.00329906995218, lng: 135.95097526811136 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1mEGNUufp8Ck0gnt5BVg83S4MTP2dvR9f_Ff7IJjwGHo/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Ⅷ", position: { lat: 35.00217045569432, lng: 135.94790983373548 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1COi42M_53Yp-hX330kODC6Y_B8H8u6Zhq5trUaMDXhc/edit?usp=sharing",  active: true },
      { name: "アメニティ南草津Xルクセア", position: { lat: 35.003885640426674, lng: 135.94866626646663 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1a403Ry9KqlM23kuotL9RoQGjwd6A9VO2A0DWd-H8sZI/edit?usp=sharing",  active: true },
      { name: "エンゼル・プラザ・ウェストⅠ", position: { lat: 34.99827564122423, lng: 135.94712003179845 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1HRIJJ8Wivl8Tyj81HStwNwfFPxvgAuGqLTwfO1AjXj8/edit?usp=sharing",  active: true },
      { name: "グラフィーネ草津野路", position: { lat: 34.99702461642501, lng: 135.9484763067471 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1E2GV7GZkjBVXhL-exYKfoLekDnBbuVguRhAE74YdvgI/edit?usp=sharing",  active: true },
      { name: "サンコート南草津", position: { lat: 35.00479591795736, lng: 135.94888524008763 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1YeVTc8r7peSKtRPBYPOXsgt5N4xqs7gJOIaorSmtZ9g/edit?usp=sharing",  active: true },
      { name: "サンコート南草津Ⅱ番館", position: { lat: 35.00495576542813, lng: 135.9496857436719 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1wBQAx4y9qZTVgUUJuCs3ezPJCEnAgJNHvSiMbdQkJsw/edit?usp=sharing",  active: true },
      { name: "サンマール南草津Ⅰ", position: { lat: 35.00345936961641, lng: 135.9483103202413 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1GgvKfKGu0VUHxG2UjnowEMHYyKyFvGzbfg57s6KVLRg/edit?usp=sharing",  active: true },
      { name: "ノイエ南草津", position: { lat: 34.9979428587465, lng: 135.95398987791182 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1bhNfN0p94m9dOl2XYnWIjZ4VvXwuFjWCG57xIG3MlwA/edit?usp=sharing",  active: true },
      { name: "プレサンスロジェ南草津", position: { lat: 35.00121556479797, lng: 135.94803411732872 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1WoCeDo93jejKWFYsk6p84sLHc4hqqHuKtT8_XgEfhH4/edit?usp=sharing",  active: true },
      { name: "ユニハイム南草津", position: { lat: 35.00124198858024, lng: 135.94832095870893 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1SAGWu9C3XsR8MiqeJQH5XTGLeX53ibCQUcGkYsXrxfk/edit?usp=sharing",  active: true },
      { name: "レスポワール南草津", position: { lat: 34.996581197328965, lng: 135.95226188836443 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1sI7Ll4-79B4q8iEOUGSd9mPqzNSfzzlfeDDsqKuhAiU/edit?usp=sharing",  active: true },
      { name: "ローレルコート南草津（夜）", position: { lat: 35.00282087021469, lng: 135.94740145118243 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Dgcf2-sle1HPIG7CWJVRHTCYvE1YWgbO7K6aGkLlimo/edit?usp=sharing",  active: true },
      //12-野路東
      { name: "グランフェリス", position: { lat: 34.99532894633182, lng: 135.95475073851347 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Q3pyYd1OzJEIkBNt8b7NkYu_gFojfXipYBD9a_9qAsY/edit?usp=sharing",  active: true },
      //13-野路町
      { name: "アメニティ南草津Ⅱ", position: { lat: 35.0057779487745, lng: 135.94795658473498 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1mSRdo_fKwX9Fgix9nsYC9sgevmoFSV2WeY-abn37Ak0/edit?usp=sharing",  active: true },
      { name: "ファミーリェ", position: { lat: 35.007507568165174, lng: 135.94802641998376 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1W5sH70H3P0w09R_gODSvUned3biiWa0DMulNpRatmd8/edit?usp=sharing",  active: true },
      { name: "メルベーユ杉", position: { lat: 35.005725967915204, lng: 135.94832143256104 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1K8LMnDr-E1rglfA9JRaG5qRLGhZgbv3o5YxCyktcphk/edit?usp=sharing",  active: true },
      { name: "利兵衛 参番館", position: { lat: 35.00741692684645, lng: 135.9424734503596 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1XgG_5nf2y-rk1JnqMutF97Xn32v0uR6x6ztlnM87gbs/edit?usp=sharing",  active: true },
      { name: "利兵衛 弐番館", position: { lat: 35.007496078757285, lng: 135.9427881313529 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Wm29DVVSsVUTsYa5_Hgx6z1TZJttMHCuH6adwYDfhwg/edit?usp=sharing",  active: true },
      //14-笠山
      { name: "DorfSt", position: { lat: 34.988414197686026, lng: 135.9447430517615 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1614-xiB2EMDXJeqIe9b7y7D2xe7gStL6bvb4rXS1BX0/edit?usp=sharing",  active: true },
      { name: "サザンパレス", position: { lat: 34.984383254840054, lng: 135.94586834697498 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1u8g4cYVHvXlIQZ6Ba37txZmFC0xpYjK8EwcB6XcbXaU/edit?usp=sharing",  active: true },
      { name: "メディカル松下南EX", position: { lat: 34.98512071325771, lng: 135.9478198106747 }, sheetUrl: "https://docs.google.com/spreadsheets/d/12VU_MykJoEVQsxmGxkt4IFzdI3wcReeD4qYWXuioV2M/edit?usp=sharing",  active: true },
      //15-南笠東
      { name: "グローバル南草津", position: { lat: 34.99434092803336, lng: 135.94652266370525 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1JppPKA3ep-85jZGKOuylpnuBESQJtKd2H8UHbxM-ptk/edit?usp=sharing",  active: true },
      //16-南笠町(該当なし)
      //17-木川町(該当なし)
      //18-橋岡町
      { name: "FOREST COURT", position: { lat: 35.012583475996465, lng: 135.9336337177914 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1xzFkwmwukbPc7C7ndg7XV_3Hebc9pTQGIPiC6EpnNdA/edit?usp=sharing",  active: true },
      { name: "VILLAGE", position: { lat: 35.011232428367535, lng: 135.93549142621404 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Mx_Kyu7neWjLFgy-w80TtKK4YYsBNX6gGytDPBjCqdk/edit?usp=sharing",  active: true },
      //19-矢橋町
      { name: "ヴィア・プレッソBASSO", position: { lat: 35.013702124767526, lng: 135.92009026020375 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1CLbadf_Nb30PcqmhlxZSw2gKVJiP3rQ9jG5dBs3xztc/edit?usp=sharing",  active: true },
      { name: "ヴィアプレッソALTO", position: { lat: 35.013702233474156, lng: 135.92009186326047 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1VQxXFAPv8YvUHlEwdbAzxnbBXbyTUXW4laY2rUsaNLQ/edit?usp=sharing",  active: true },
      //20-新浜町
      { name: "アルファスマート草津新浜町", position: { lat: 34.9967523, lng: 135.9219213 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1-LPqRzYOdrm1TIxeiSDwTXP2RW-uYaoR/edit?usp=sharing&ouid=108848249071620523779&rtpof=true&sd=true",  active: false },
    ];

      function convertSheetToCsvUrl(sheetUrl) {
        const m = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
        if (!m) return null;
        const sheetId = m[1];
        
        // 特定のGIDを指定せず、スプレッドシート全体のデータをCSVとして書き出す設定に変更
        // 後の処理で「部屋一覧」という名前のシートを特定します
        return `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent("部屋一覧")}`;
      }

      async function fetchVisitStatus(apt) {
      if (!apt.active || !apt.sheetUrl) return { color: "default" };
      try {
        const res = await fetch(convertSheetToCsvUrl(apt.sheetUrl));
        const text = await res.text();
        
        // CSVの各行をパース（カンマで分割。引用符がある場合も考慮）
        const rows = text.split(/\r?\n/).map(row => {
          // 引用符 " で囲まれた値を考慮して分割
          return row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
        });
        
        let totalRooms = 0;
        let enteredCount = 0;

        // 2行目以降（ヘッダーを除いた実データ部分）をスキャン
        // ※ gviz/tq を使うとインデックスが変わる可能性があるため、全体を確認
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (!row || row.length < 2) continue;

          const room = row[0]; // 1列目: 部屋番号
          const visit = row[1]; // 2列目: 訪問状況

          // 【重要】部屋番号が「数字のみ」または「号室」などの文字を含む、
          // かつ明らかにシステム的なヘッダーや空行でない場合のみカウント
          if (room && room !== "" && !room.includes("部屋番号") && !room.includes("table")) {
            totalRooms++;
            // 訪問状況に文字が入っていればカウント
            if (visit && visit !== "") {
              enteredCount++;
            }
          }
        } 

        if (totalRooms === 0) return { color: "default" };

        const ratio = enteredCount / totalRooms;
        console.log(`${apt.name}: ${enteredCount}/${totalRooms} (${(ratio * 100).toFixed(1)}%)`);

        // 判定ロジック
        if (ratio >= 1.0) return { color: "red" };
        if (ratio >= 0.5) return { color: "yellow" };
        return { color: "default" };
      } catch (e) { 
        console.error(`${apt.name} のデータ取得失敗:`, e);
        return { color: "default" }; 
      }
    }

    async function addApartmentMarkers() {
      const scales = getMarkerScale();
      
      apartments.forEach((apt) => {
        // 1. まずは「デフォルト色（青緑）」で即座にマーカーを作成して表示
        const marker = new google.maps.Marker({
          position: apt.position,
          map: map,
          title: apt.name,
          icon: {
            // 軽量化したピン型パス（計算負荷が低い）
            path: "M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z",
            fillColor: "#00A0A0", // デフォルト色
            fillOpacity: 1.0,
            strokeColor: "white",
            strokeWeight: 1.5,
            scale: scales.apt * 70, // パスが小さいため、係数を掛けて調整
            anchor: new google.maps.Point(12, 22)
          }
        });

        // 2. クリックイベントは即座に登録（データ読み込みを待たずに開ける）
        if (apt.active && apt.sheetUrl) {
          marker.addListener("click", () => window.open(apt.sheetUrl, "_blank"));
          
          // 3. 非同期で個別にステータス（スプレッドシート）を確認
          // 完了したピンから順次、色を更新していく
          fetchVisitStatus(apt).then(result => {
            let newColor = !apt.active ? "#808080" : 
                          (result.color === "red" ? "#E53935" : 
                          (result.color === "yellow" ? "#FBC02D" : "#00A0A0"));
            
            const icon = marker.getIcon();
            if (icon.fillColor !== newColor) {
              icon.fillColor = newColor;
              marker.setIcon(icon); // 色だけを更新
            }
          });
        }
        apartmentMarkerObjects.push(marker);
      });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center: INITIAL_CENTER, zoom: 16 });
      addApartmentMarkers();

      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(
          position => {
            const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
            const scales = getMarkerScale();
            
            if (!userMarker) {
              shadowMarker = new google.maps.Marker({
                position: userPos, map: map, zIndex: 1,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: scales.user * 1.4, fillColor: "black", fillOpacity: 0.2, strokeWeight: 0 }
              });
              userMarker = new google.maps.Marker({
                position: userPos, map: map, zIndex: 2, title: "現在地",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: scales.user, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
              });
              map.setCenter(userPos);
            } else {
              userMarker.setPosition(userPos);
              shadowMarker.setPosition(userPos);
            }
          },
          error => {
            console.warn(error.message);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      }

      // アニメーション処理
      setInterval(() => {
        if (!userMarker) return;
        const base = getMarkerScale().user;
        const icon = userMarker.getIcon(); // アイコンオブジェクトを取得
        let s = icon.scale;

        // this.growing ではなく変数 isGrowing を使用
        if (isGrowing) {
          s += 0.3;
          if (s >= base * 1.3) isGrowing = false;
        } else {
          s -= 0.3;
          if (s <= base) isGrowing = true;
        }

        icon.scale = s;
        userMarker.setIcon(icon);
      }, 100);

      // リサイズ時にアイコンを即座に更新
      window.addEventListener('resize', () => {
        const s = getMarkerScale();

        apartmentMarkerObjects.forEach(m => { 
          const i = m.getIcon(); 
          if (i) { // アイコンが存在する場合のみ実行（ガード）
            i.scale = s.apt * 70;
            m.setIcon(i); 
          }
        });

        if (userMarker) { 
          const i = userMarker.getIcon(); 
          if (i) { // ガードを追加
            i.scale = s.user; 
            userMarker.setIcon(i);
          }
        }
      });
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH5MfDcxPbehciSlK36IrnVPH2LTBUQ_A&callback=initMap" async defer></script>
</body>
</html>
